<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="leaflet.css">
    <script src="leaflet.js"></script>
    <script src="heatmap.min.js"></script>
    <script src="leaflet-heatmap.js"></script>
    <script src="heatmapData.js"></script>
    <script src="jquery-3.4.1.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        html,
        body,
        #map {
            width: 100%;
            height: 700px;
        }

        #top-bar {
            top: 0;
            left: 0;
            width: 100%;
            height: 52px;
            background-color: gray;
        }

        #tool {
            top: 15px;
            position: relative;
        }

        #top-bar label {
            font-family: 'Times New Roman';
            font-size: 14px;
        }

        #top-bar input {
            width: 100px;
            font-size: 16px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="top-bar">
        <div id="tool">
            <label>Lng:</label><input id="lon">
            <label>Lat:</label><input id="lat">
            <label>Val:</label><input id="val">
            <button id="click-map" title="点击地图获取经纬度">点击</button>
            <button
                id="add">添加</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <label>minLng:</label><input id="min-lon">
            <label>minLat:</label><input id="min-lat">
            <label>maxLng:</label><input id="max-lon">
            <label>maxLat:</label><input id="max-lat">
            <button id="search">查询</button>
            <button id="heatmap-show">热力图</button>
        </div>
    </div>
    <div id="map"></div>
    <script>

        //加载高德底图
        var url = "http://webrd0{s}.is.autonavi.com/appmaptile?x={x}&y={y}&z={z}&lang=zh_cn&size=1&scale=1&style=8";
        var gaodeLayer = new L.TileLayer(url, {
            subdomains: "1234"
        });

        // //加载OSM底图
        // var baseLayer = L.tileLayer(
        //     'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        //     attribution: '...',
        //     maxZoom: 18
        // } );

        //设置heatmap样式
        var cfg = {
            "radius": .07,
            "maxOpacity": .6,
            "minOpacity": .3,
            "scaleRadius": true,         //设置热力点是否平滑过渡
            "useLocalExtrema": true,     //使用局部极值
            "latField": "lat",
            "lngField": "lon",
            "valueField": "value"
        };

        var heatmapLayer = new HeatmapOverlay(cfg);

        var map = new L.Map('map', {
            center: new L.LatLng(30.93555, 114.39201),
            zoom: 10,
            layers: [gaodeLayer, heatmapLayer]
        });

        var icon = L.icon({
            iconUrl: "./images/position.png",
        });

        $("#click-map").click(function () {
            map.on("click", function (e) {
                $("#lon").val(e.latlng.lng.toFixed(6))
                $("#lat").val(e.latlng.lat.toFixed(6))
                //var marker = L.marker([$("#lat").val(), $("#lon").val()],{icon}).addTo(map);
            });
        });

        //将数据添加到数据库，跨域
        $("#add").click(function () {
            var script = document.createElement("script");
            script.type = "text/javascript";
            script.src = "http://localhost:8080/insert?value=" + $("#val").val() + "&lon=" + $("#lon").val() + "&&lat=" + $("#lat").val();
            document.head.appendChild(script)
            alert("添加成功");
        });
        
        //根据区域范围查询要素点
        var dataSet = [];
        var marker;
        $("#search").click(function () {
            $.get("http://localhost:8080/get1?minX=" + $("#min-lat").val() + "&minY=" + $("#min-lon").val() + "&maxX=" + $("#max-lat").val() + "&maxY=" + $("#max-lon").val(), function (data, status) {
                for (var i = 0; i < data.length; ++i) {
                    marker = L.marker([data[i].lat, data[i].lon], { icon, title:data[i].value}).addTo(map);
                    dataSet.push(data[i]);
                }
            });
        });
        //console.log(dataSet);

        var testData = {
            max: 100,
            data: dataSet
        };


        $("#heatmap-show").click(function () {
            heatmapLayer.setData(testData);
        });
    </script>
</body>

</html>